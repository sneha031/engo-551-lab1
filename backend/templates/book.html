<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Book</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

  <div class="nav">
    {% if session.get("user_id") %}
      <div>Logged in as <b>{{ session.get("username") }}</b></div>
      <div>|</div>
      <a href="{{ url_for('index') }}">Search</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    {% else %}
      <a href="{{ url_for('login') }}">Login</a>
      <a href="{{ url_for('register') }}">Register</a>
    {% endif %}
  </div>

  {% if message %}
    <div class="msg">{{ message }}</div>
  {% endif %}

  <h2>{{ book.title }}</h2>

  <div class="card">
    <div><b>Author:</b> {{ book.author }}</div>
    <div><b>Year:</b> {{ book.year }}</div>
    <div><b>ISBN:</b> {{ book.isbn }}</div>

    {% if stats %}
      <div style="margin-top:10px;">
        <b>Class reviews:</b> {{ stats.count }} review(s), average {{ "%.2f"|format(stats.avg) }}/5
      </div>
    {% endif %}

    <div style="margin-top:10px;">
  <b>Google Books:</b>
  {% if ginfo %}
    average {{ ginfo.avg if ginfo.avg is not none else "N/A" }},
    ratings {{ ginfo.count if ginfo.count is not none else "N/A" }}
    {% if ginfo.link %}
      - <a href="{{ ginfo.link }}" target="_blank">Open on Google Books</a>
    {% endif %}
    {% if ginfo.thumb %}
      <div style="margin-top:8px;">
        <img src="{{ ginfo.thumb }}" alt="Cover">
      </div>
    {% endif %}
  {% else %}
    Not available
  {% endif %}
</div>

  <h3>Leave a review</h3>
  <form method="post" action="{{ url_for('book_page', isbn=book.isbn) }}">
    <div class="card">
      <div class="small">Stars (1–5)</div>
      <select name="rating">
        <option value="">Select...</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>

      <div style="margin-top:10px;" class="small">Comment</div>
      <textarea name="review_text" rows="4" placeholder="Write your review..."></textarea>

      <div style="margin-top:12px;">
        <button type="submit">Submit review</button>
      </div>
    </div>
  </form>

  <h3>Other reviews</h3>

  {% if reviews and reviews|length > 0 %}
    {% for r in reviews %}
      <div class="card">
        <div>
          <b>{{ r.username }}</b>
          <span class="small">| {{ r.created_at }}</span>
        </div>

        <div class="stars" style="margin-top:6px;">
          {% for _ in range(r.rating) %}★{% endfor %}
          {% for _ in range(5 - r.rating) %}☆{% endfor %}
        </div>

        <div style="margin-top:8px;">{{ r.review_text }}</div>
      </div>
    {% endfor %}
  {% else %}
    <div class="card">No reviews yet.</div>
  {% endif %}

</body>
</html>
